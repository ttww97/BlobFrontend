name: Deploy Frontend to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  JAVA_VERSION: '24'
  NODE_VERSION: '18'

jobs:
  build:
    name: Build WAR
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Configure npm registry
      run: |
        cd frontend
        npm config set registry https://mirrors.cloud.tencent.com/npm/
        npm config set fetch-retries 5
        npm config set fetch-retry-mintimeout 20000
        npm config set fetch-retry-maxtimeout 60000

    - name: Build WAR
      run: |
        echo "=== 构建 WAR 包（前端）==="
        mvn clean package -DskipTests

    - name: Verify WAR
      run: |
        echo "=== 检查构建产物 ==="
        ls -lh target/*.war || true
        
        if [ -f "target/BlobFrontend-1.0-SNAPSHOT.war" ]; then
          echo "✅ WAR 包生成成功"
          ls -lh target/BlobFrontend-1.0-SNAPSHOT.war
        else
          echo "❌ WAR 包未生成"
          exit 1
        fi

    - name: Upload WAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: war-artifact
        path: target/BlobFrontend-1.0-SNAPSHOT.war
        retention-days: 7

  deploy:
    name: Deploy to Server
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download WAR artifact
      uses: actions/download-artifact@v4
      with:
        name: war-artifact
        path: artifacts/

    - name: Deploy to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "artifacts/*"
        target: "/opt/blob-frontend/deploy/"
        strip_components: 0

    - name: Deploy frontend WAR
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "=== 部署前端 WAR 包 ==="
          
          # 设置 Java 环境变量
          export JAVA_HOME=/usr/lib/jvm/jdk-24.0.1
          export PATH=$JAVA_HOME/bin:$PATH
          
          # 定义 Tomcat 路径
          TOMCAT_WEBAPPS="/usr/local/tomcat/webapps"
          TOMCAT_BIN="/usr/local/tomcat/bin"
          WAR_SOURCE="/opt/blob-frontend/deploy/BlobFrontend-1.0-SNAPSHOT.war"
          
          # 检查 WAR 文件是否存在
          if [ ! -f "$WAR_SOURCE" ]; then
            echo "❌ WAR 文件不存在: $WAR_SOURCE"
            exit 1
          fi
          
          echo "✅ 找到 WAR 文件: $WAR_SOURCE"
          
          # 1. 停止 Tomcat
          echo "--> 正在停止 Tomcat..."
          $TOMCAT_BIN/shutdown.sh
          sleep 8
          
          # 2. 清理旧的部署
          echo "--> 正在清理旧的 ROOT 部署..."
          rm -rf $TOMCAT_WEBAPPS/ROOT
          rm -f $TOMCAT_WEBAPPS/ROOT.war
          
          # 3. 部署新的 WAR 包为 ROOT.war
          echo "--> 正在部署新的 WAR 包为 ROOT.war..."
          cp "$WAR_SOURCE" "$TOMCAT_WEBAPPS/ROOT.war"
          
          # 4. 启动 Tomcat
          echo "--> 正在启动 Tomcat..."
          $TOMCAT_BIN/startup.sh
          
          echo "✅ 前端 WAR 包已部署到 Tomcat（端口 8080）"

    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "=== 验证部署 ==="
          
          # 等待 Tomcat 启动和部署完成
          echo "等待 Tomcat 启动和部署完成..."
          sleep 15
          
          # 检查前端服务
          echo "检查前端服务（端口 8080）..."
          if curl -s http://localhost:8080/ > /dev/null 2>&1; then
            echo "✅ 前端服务运行正常"
            echo "响应状态码: $(curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/)"
          else
            echo "⚠️  前端服务未响应（可能需要等待更长时间）"
            echo "检查 Tomcat 日志:"
            tail -20 /usr/local/tomcat/logs/catalina.out || echo "无法读取 Tomcat 日志"
          fi
          
          echo ""
          echo "=== 部署完成 ==="
          echo "前端地址: http://${{ secrets.SERVER_HOST }}:8080"
          echo ""
          echo "部署信息："
          echo "  WAR 文件: /opt/blob-frontend/deploy/BlobFrontend-1.0-SNAPSHOT.war"
          echo "  Tomcat 路径: /usr/local/tomcat"
          echo "  部署位置: /usr/local/tomcat/webapps/ROOT.war"

